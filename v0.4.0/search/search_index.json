{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"],"fields":{"title":{"boost":1000.0},"text":{"boost":1.0},"tags":{"boost":1000000.0}}},"docs":[{"location":"","title":"AP Explanation API","text":"<p>This is the documentation site for the AP Explanation service. The service provides a RESTful API for annotating and explaining data provenance using semiring annotations in PostgreSQL with ProvSQL.</p>"},{"location":"#what-is-data-provenance","title":"What is Data Provenance?","text":"<p>Data provenance tracks the origin and transformation history of data. This service uses semiring annotations to capture how query results are derived from source data.</p> <p>Provenance annotations enable: - Understanding data lineage and transformations - Debugging complex queries - Ensuring reproducibility and compliance - Analyzing data dependencies</p>"},{"location":"#quick-links","title":"Quick Links","text":"<ul> <li>API - OpenAPI specification</li> <li>Configuration - How to configure the service</li> <li>Architecture - Technical architecture details</li> </ul>"},{"location":"#working-with-analytical-patterns-ap","title":"Working with Analytical Patterns (AP)","text":"<p>The service processes Analytical Patterns (AP) in PG-JSON format\u2014a graph structure with nodes and edges representing database operations.</p>"},{"location":"#example-ap-structure","title":"Example AP Structure","text":"<pre><code>{\n  \"nodes\": [\n    {\n      \"id\": \"db-node-id\",\n      \"labels\": [\"Relational_Database\"],\n      \"properties\": {\n        \"contentUrl\": \"postgresql://user:pass@host/db\",\n        \"name\": \"public\"\n      }\n    },\n    {\n      \"id\": \"table-node-id\",\n      \"labels\": [\"Table\"],\n      \"properties\": {\"name\": \"students\"}\n    },\n    {\n      \"id\": \"query-node-id\",\n      \"labels\": [\"Provenance_SQL_Operator\"],\n      \"properties\": {\n        \"query\": \"SELECT name FROM students WHERE grade &gt; 80\"\n      }\n    }\n  ],\n  \"edges\": [\n    {\"from\": \"query-node-id\", \"to\": \"table-node-id\", \"labels\": [\"input\"]},\n    {\"from\": \"table-node-id\", \"to\": \"db-node-id\", \"labels\": [\"contain\"]}\n  ]\n}\n</code></pre>"},{"location":"#workflow","title":"Workflow","text":"<ol> <li>Annotate tables (one-time): <code>POST /api/v1/aps/annotate</code> \u2014 Prepares tables for provenance tracking</li> <li>Explain queries: <code>POST /api/v1/aps/explain</code> \u2014 Returns provenance information showing how results derive from source data</li> <li>Note: This endpoint automatically removes annotations after computation to prevent database blocking issues</li> </ol> <p>The AP graph defines the database connection, tables, and query. The service extracts these components and applies provenance tracking.</p>"},{"location":"#getting-started","title":"Getting Started","text":"<p>The best solution is to use the provided <code>.devcontainer</code> configuration. The PostgreSQL database with ProvSQL will already be configured.</p> <p>To run it locally without the devcontainer:</p> <pre><code># Requirements: Python 3.14, uv, PostgreSQL with ProvSQL extension\nuv sync --all-groups\ncp .env.example .env\n# Fill in the required variables in .env:\n#   POSTGRES_USER, POSTGRES_PASSWORD, POSTGRES_HOST\n#   Optional: POSTGRES_PORT, POSTGRES_TIMESCALE_HOST, POSTGRES_TIMESCALE_PORT\nuv run ap_explanation/main.py\n</code></pre> <p>The API will be available at <code>http://localhost:5000/api/v1</code></p>"},{"location":"#interactive-documentation","title":"Interactive Documentation","text":"<ul> <li>Swagger UI: http://localhost:5000/docs</li> <li>ReDoc: http://localhost:5000/redoc</li> </ul>"},{"location":"architecture/","title":"Service Architecture","text":"<p>The AP Explanation service is a RESTful API designed to annotate SQL queries and explain data provenance using PostgreSQL with the ProvSQL extension. This document outlines the key components and their interactions.</p>"},{"location":"architecture/#high-level-architecture","title":"High-Level Architecture","text":"<p>The AP Explanation service follows a layered architecture:</p> <pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502       FastAPI REST API Layer            \u2502\n\u2502                                         \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                  \u2502\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502      Business Logic (Services) Layer    \u2502\n|                                         |\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                  \u2502\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502    Data Access / Repository Layer       \u2502\n|    (Provenance queries and mappings)    |\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                  \u2502\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502    PostgreSQL + ProvSQL Extension       \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"architecture/#database-requirements","title":"Database Requirements","text":"<p>The service has specific database prerequisites:</p> <ul> <li> <p>PostgreSQL with ProvSQL Extension: The underlying database must have the ProvSQL extension installed. ProvSQL adds provenance tracking capabilities to PostgreSQL, enabling the tracking of data lineage through SQL queries.</p> </li> <li> <p>Dual Database Architecture: The service supports connecting to databases across two PostgreSQL instances:</p> </li> <li>Primary PostgreSQL: The service first attempts to connect to the database on the primary PostgreSQL server (configured via <code>POSTGRES_HOST</code> and <code>POSTGRES_PORT</code>)</li> <li>Timescale Fallback: If the database doesn't exist on the primary server, it automatically falls back to a Timescale/secondary PostgreSQL server (configured via <code>POSTGRES_TIMESCALE_HOST</code> and <code>POSTGRES_TIMESCALE_PORT</code>)</li> <li> <p>This architecture enables flexible deployment with databases distributed across multiple instances</p> </li> <li> <p>Dynamic Connection Management: Connection pools are created per-AP (Analytical Pattern) processing and cleaned up after completion, ensuring efficient resource utilization</p> </li> <li> <p>Automatic Initialization: When the service connects to the database, it automatically pushes semiring type definitions and related functions. This includes:</p> </li> <li>Custom PostgreSQL types for semiring state management</li> <li>Semiring operation functions (addition, multiplication, monus)</li> <li>Aggregate functions for combining provenance information</li> </ul> <p>This initialization is handled transparently by the repository layer and ensures the database has all necessary provenance tracking infrastructure.</p>"},{"location":"architecture/#core-concepts","title":"Core Concepts","text":""},{"location":"architecture/#semiring-annotations","title":"Semiring Annotations","text":"<p>The service supports multiple semiring types for provenance tracking:</p> <ul> <li>formula: Tracks the complete lineage formula showing how results derive from source data</li> <li>why: Provides why-provenance explaining which source tuples contributed to results</li> </ul> <p>Each semiring has: - A retrieval function (e.g., <code>formula</code>, <code>whyprov_now</code>) - An optional aggregate function - A mapping table name, that will be the name of the table holding the info about provenance  - A \"mapping strategy\". Each row needs to be associated with a unique id to be able to trace back the data. The default mapping uses Postgres ctid to identify each row.</p>"},{"location":"architecture/#sql-rewriting","title":"SQL Rewriting","text":"<p>The <code>SqlRewriter</code> class (<code>internal/sql_rewriter.py</code>) transforms SQL queries to include provenance tracking:</p> <p>Non-aggregate queries: <pre><code>-- Original\nSELECT name FROM students WHERE grade &gt; 80\n\n-- Rewritten\nSELECT name, whyprov_now(provenance(), 'why_mapping') \nFROM students WHERE grade &gt; 80\n</code></pre></p> <p>Aggregate queries: <pre><code>-- Original\nSELECT department, COUNT(*) FROM employees GROUP BY department\n\n-- Rewritten (wraps as subquery)\nSELECT department, COUNT(*), \n       aggregation_formula(prov_agg, 'formula_mapping')\nFROM (SELECT department, COUNT(*) as cnt, \n             provenance() as prov_agg\n      FROM employees GROUP BY department) AS subquery\n</code></pre></p>"},{"location":"architecture/#limitations-and-known-issues","title":"Limitations and Known Issues","text":""},{"location":"architecture/#sql-support","title":"SQL Support","text":"<ul> <li>Query types: Only <code>SELECT</code> queries are supported</li> <li>HAVING clause: Not currently supported in query rewriting</li> </ul>"},{"location":"architecture/#mapping-strategy","title":"Mapping Strategy","text":"<ul> <li>Currently uses PostgreSQL <code>ctid</code> (row identifier)</li> <li><code>ctid</code> can change on VACUUM FULL operations</li> </ul>"},{"location":"architecture/#key-design-patterns","title":"Key Design Patterns","text":""},{"location":"architecture/#dependency-injection","title":"Dependency Injection","text":"<p>The service uses a DI container (defined in <code>di.py</code>) to manage dependencies: - Dynamic Service Creation: Service instances are created per-AP processing request using a factory function (<code>get_provenance_service_for_ap</code>) - Connection Pool Management: Connection pools are created when an AP is processed and cleaned up after completion - Database Routing: The DI system handles automatic routing between primary PostgreSQL and Timescale instances - Repository Layer: Repositories are created with database connections from the appropriate pool - Enables easier testing and component isolation</p>"},{"location":"configuration/","title":"Configuration","text":"<p>This document describes how to configure the AP Explanation service for different environments.</p>"},{"location":"configuration/#environment-variables","title":"Environment Variables","text":"<p>The service requires the following environment variables to connect to PostgreSQL databases:</p>"},{"location":"configuration/#required-variables","title":"Required Variables","text":"<ul> <li><code>POSTGRES_USER</code>: PostgreSQL username</li> <li><code>POSTGRES_PASSWORD</code>: PostgreSQL password  </li> <li><code>POSTGRES_HOST</code>: Hostname or IP address of the primary PostgreSQL server</li> </ul>"},{"location":"configuration/#optional-variables","title":"Optional Variables","text":"<ul> <li><code>POSTGRES_PORT</code>: Port for the primary PostgreSQL server (default: <code>5432</code>)</li> <li><code>POSTGRES_TIMESCALE_HOST</code>: Hostname for the Timescale/secondary PostgreSQL server</li> <li><code>POSTGRES_TIMESCALE_PORT</code>: Port for the Timescale server (default: <code>5433</code>)</li> <li><code>ROOT_PATH</code>: Root path for the API when behind a reverse proxy (default: <code>\"\"</code>)</li> </ul>"},{"location":"configuration/#database-connection-behavior","title":"Database Connection Behavior","text":"<p>The service supports a dual-database architecture:</p> <ol> <li>Primary Connection: The service first attempts to connect to the database specified in the Analytical Pattern on the primary PostgreSQL server (<code>POSTGRES_HOST:POSTGRES_PORT</code>)</li> <li>Fallback Connection: If the database doesn't exist on the primary server, the service automatically falls back to the Timescale server (<code>POSTGRES_TIMESCALE_HOST:POSTGRES_TIMESCALE_PORT</code>)</li> <li>Error Handling: If the database doesn't exist on either server, a <code>DatabaseNotFoundError</code> is raised</li> </ol> <p>This architecture allows for flexible database deployment, supporting scenarios where databases are distributed across multiple PostgreSQL instances.</p>"},{"location":"configuration/#postgresql-with-provsql","title":"PostgreSQL with ProvSQL","text":""},{"location":"configuration/#database-requirements","title":"Database Requirements","text":"<p>The service requires a PostgreSQL database with the following:</p> <ol> <li> <p>ProvSQL Extension: The database must have the ProvSQL extension installed and enabled. ProvSQL provides provenance tracking capabilities for SQL queries.</p> </li> <li> <p>Semiring Definitions: The service automatically initializes semiring type definitions and aggregate functions when connecting to the database. This includes:</p> </li> <li>Custom composite types (<code>formula_state</code>, <code>whyprov_state</code>, etc.)</li> <li>Semiring operation functions (plus, times, monus)</li> <li>Aggregate functions for provenance tracking</li> </ol> <p>These definitions are automatically created from the SQL script at <code>ap_explanation/repository/resources/03_setup_semiring_parallel.sql</code> during the first connection.</p>"},{"location":"configuration/#using-the-pre-configured-docker-image","title":"Using the Pre-configured Docker Image","text":"<p>A pre-configured Docker image with PostgreSQL and ProvSQL is available:</p> <pre><code>cd dependencies/postgres-provsql\ndocker build -t postgres-provsql .\n</code></pre> <p>This image includes: - PostgreSQL with the ProvSQL extension pre-installed - All necessary dependencies and configurations</p>"},{"location":"configuration/#testing-configuration","title":"Testing Configuration","text":"<p>Tests automatically use testcontainers to spin up a PostgreSQL instance with ProvSQL. No manual configuration needed for running tests:</p> <pre><code>pytest tests/\n</code></pre> <p>The test configuration is defined in <code>tests/conftest.py</code>.</p>"},{"location":"development/","title":"Development Guide","text":""},{"location":"development/#setup","title":"Setup","text":""},{"location":"development/#with-dev-container-recommended","title":"With Dev Container (Recommended)","text":"<p>Open in VS Code with the Dev Containers extension. PostgreSQL with ProvSQL is pre-configured.</p>"},{"location":"development/#local-setup","title":"Local Setup","text":"<p>Requirements: Python 3.14, <code>uv</code> package manager, PostgreSQL with ProvSQL</p> <pre><code># Install dependencies\nuv sync --all-groups\n\n# Configure environment\ncp .env.example .env\n# Edit .env with your database connection details:\n#   - POSTGRES_USER\n#   - POSTGRES_PASSWORD\n#   - POSTGRES_HOST\n#   - POSTGRES_PORT (optional, defaults to 5432)\n#   - POSTGRES_TIMESCALE_HOST (optional, for fallback database)\n#   - POSTGRES_TIMESCALE_PORT (optional, defaults to 5433)\n#   - ROOT_PATH (optional, for reverse proxy setups)\n\n# Run service\nuv run ap_explanation/main.py\n</code></pre>"},{"location":"development/#running-tests","title":"Running Tests","text":"<pre><code># All tests\npytest tests/\n\n# Specific test file\npytest tests/test_int_annotate.py\n\n# With coverage\npytest tests/ --cov=ap_explanation\n</code></pre> <p>Tests use testcontainers to spin up PostgreSQL with ProvSQL automatically.</p>"},{"location":"development/#project-structure","title":"Project Structure","text":"<pre><code>ap_explanation/\n\u251c\u2500\u2500 api/v1/              # API endpoints\n\u2502   \u251c\u2500\u2500 annotate/        # Annotation endpoints\n\u2502   \u251c\u2500\u2500 explain/         # Explanation endpoints\n\u2502   \u251c\u2500\u2500 dependencies/    # FastAPI dependencies (AP parser)\n\u2502   \u2514\u2500\u2500 health.py        # Health check endpoint\n\u251c\u2500\u2500 services/            # Business logic\n\u251c\u2500\u2500 repository/          # Data access layer\n\u2502   \u251c\u2500\u2500 mapping/         # Mapping strategies (ctid, etc.)\n\u2502   \u2514\u2500\u2500 resources/       # SQL scripts for semiring setup\n\u251c\u2500\u2500 internal/            # SQL rewriting\n\u251c\u2500\u2500 types/               # Type definitions (PG-JSON, semiring)\n\u251c\u2500\u2500 errors/              # Custom exceptions\n\u251c\u2500\u2500 semirings.py         # Semiring configurations\n\u251c\u2500\u2500 di.py                # Dependency injection\n\u2514\u2500\u2500 main.py              # FastAPI application entry point\n</code></pre>"},{"location":"development/#adding-a-new-semiring","title":"Adding a New Semiring","text":"<ol> <li>Define the semiring in <code>ap_explanation/semirings.py</code>:</li> </ol> <pre><code>DbSemiring(\n    name=\"custom\",\n    retrieval_function=\"custom_prov\",\n    aggregate_function=\"custom_agg\",  # Optional\n    mapping_table=\"custom_mapping\",\n    mappingStrategy=CtidMapping(),\n)\n</code></pre> <ol> <li>Create database functions in <code>repository/resources/03_setup_semiring_parallel.sql</code>:</li> </ol> <pre><code>CREATE OR REPLACE FUNCTION custom_prov(...)\n-- Implementation\n</code></pre> <ol> <li>Test the new semiring:</li> </ol> <pre><code># Add test in tests/\n</code></pre>"},{"location":"development/#code-quality","title":"Code Quality","text":"<pre><code># Format &amp; lint\npre-commit run --all-files\n\n# Type checking (if using mypy)\nmypy ap_explanation/\n</code></pre>"},{"location":"development/#documentation","title":"Documentation","text":"<p>Build documentation locally:</p> <pre><code>cd docs/\nmkdocs serve\n</code></pre> <p>Visit http://localhost:8000</p>"},{"location":"openapi/","title":"API","text":""},{"location":"openapi/#ap-explanation-api-001","title":"AP Explanation API 0.0.1","text":"<p>API for explaining Analytical Patterns with provenance tracking using ProvSQL</p>"},{"location":"openapi/#endpoints","title":"Endpoints","text":""},{"location":"openapi/#get","title":"GET /","text":"<p>Index</p> <p> Response 200 OK </p> application/json Schema of the response body"},{"location":"openapi/#v1","title":"v1","text":""},{"location":"openapi/#post-apiv1apsannotate","title":"POST /api/v1/aps/annotate","text":"<p>Annotate Ap</p> Description <p>Annotate the AP with all available semirings using dynamic database connection.</p> <p>Request body</p> application/json <p><pre><code>{\n    \"nodes\": [\n        {\n            \"id\": \"string\",\n            \"labels\": [\n                \"string\"\n            ],\n            \"properties\": null\n        }\n    ],\n    \"edges\": [\n        {\n            \"from\": \"string\",\n            \"labels\": [\n                \"string\"\n            ],\n            \"to\": \"string\",\n            \"properties\": null\n        }\n    ]\n}\n</code></pre> \u26a0\ufe0f This example has been generated automatically from the schema and it is not accurate. Refer to the schema for more information.</p> Schema of the request body <pre><code>{\n    \"properties\": {\n        \"nodes\": {\n            \"items\": {\n                \"$ref\": \"#/components/schemas/PgJsonNode\"\n            },\n            \"type\": \"array\",\n            \"title\": \"Nodes\"\n        },\n        \"edges\": {\n            \"items\": {\n                \"$ref\": \"#/components/schemas/PgJsonEdge\"\n            },\n            \"type\": \"array\",\n            \"title\": \"Edges\"\n        }\n    },\n    \"type\": \"object\",\n    \"required\": [\n        \"nodes\",\n        \"edges\"\n    ],\n    \"title\": \"PgJson\"\n}\n</code></pre> <p> Response 200 OK </p> application/json <p><pre><code>[\n    {\n        \"table_name\": \"string\",\n        \"semiring\": \"string\",\n        \"status\": \"success\",\n        \"message\": \"string\"\n    }\n]\n</code></pre> \u26a0\ufe0f This example has been generated automatically from the schema and it is not accurate. Refer to the schema for more information.</p> Schema of the response body <pre><code>{\n    \"items\": {\n        \"$ref\": \"#/components/schemas/AnnotationResult\"\n    },\n    \"type\": \"array\",\n    \"title\": \"Response Annotate Ap Api V1 Aps Annotate Post\"\n}\n</code></pre> <p> Response 422 Unprocessable Content </p> application/json <p><pre><code>{\n    \"detail\": [\n        {\n            \"loc\": [\n                null\n            ],\n            \"msg\": \"string\",\n            \"type\": \"string\"\n        }\n    ]\n}\n</code></pre> \u26a0\ufe0f This example has been generated automatically from the schema and it is not accurate. Refer to the schema for more information.</p> Schema of the response body <pre><code>{\n    \"properties\": {\n        \"detail\": {\n            \"items\": {\n                \"$ref\": \"#/components/schemas/ValidationError\"\n            },\n            \"type\": \"array\",\n            \"title\": \"Detail\"\n        }\n    },\n    \"type\": \"object\",\n    \"title\": \"HTTPValidationError\"\n}\n</code></pre>"},{"location":"openapi/#delete-apiv1apsannotate","title":"DELETE /api/v1/aps/annotate","text":"<p>Remove Annotation Ap</p> Description <p>Remove annotations from AP tables for all available semirings using dynamic database connection.</p> <p>Request body</p> application/json <p><pre><code>{\n    \"nodes\": [\n        {\n            \"id\": \"string\",\n            \"labels\": [\n                \"string\"\n            ],\n            \"properties\": null\n        }\n    ],\n    \"edges\": [\n        {\n            \"from\": \"string\",\n            \"labels\": [\n                \"string\"\n            ],\n            \"to\": \"string\",\n            \"properties\": null\n        }\n    ]\n}\n</code></pre> \u26a0\ufe0f This example has been generated automatically from the schema and it is not accurate. Refer to the schema for more information.</p> Schema of the request body <pre><code>{\n    \"properties\": {\n        \"nodes\": {\n            \"items\": {\n                \"$ref\": \"#/components/schemas/PgJsonNode\"\n            },\n            \"type\": \"array\",\n            \"title\": \"Nodes\"\n        },\n        \"edges\": {\n            \"items\": {\n                \"$ref\": \"#/components/schemas/PgJsonEdge\"\n            },\n            \"type\": \"array\",\n            \"title\": \"Edges\"\n        }\n    },\n    \"type\": \"object\",\n    \"required\": [\n        \"nodes\",\n        \"edges\"\n    ],\n    \"title\": \"PgJson\"\n}\n</code></pre> <p> Response 200 OK </p> application/json <p><pre><code>[\n    {\n        \"table_name\": \"string\",\n        \"semiring\": \"string\",\n        \"status\": \"success\",\n        \"message\": \"string\"\n    }\n]\n</code></pre> \u26a0\ufe0f This example has been generated automatically from the schema and it is not accurate. Refer to the schema for more information.</p> Schema of the response body <pre><code>{\n    \"items\": {\n        \"$ref\": \"#/components/schemas/RemovalResult\"\n    },\n    \"type\": \"array\",\n    \"title\": \"Response Remove Annotation Ap Api V1 Aps Annotate Delete\"\n}\n</code></pre> <p> Response 422 Unprocessable Content </p> application/json <p><pre><code>{\n    \"detail\": [\n        {\n            \"loc\": [\n                null\n            ],\n            \"msg\": \"string\",\n            \"type\": \"string\"\n        }\n    ]\n}\n</code></pre> \u26a0\ufe0f This example has been generated automatically from the schema and it is not accurate. Refer to the schema for more information.</p> Schema of the response body <pre><code>{\n    \"properties\": {\n        \"detail\": {\n            \"items\": {\n                \"$ref\": \"#/components/schemas/ValidationError\"\n            },\n            \"type\": \"array\",\n            \"title\": \"Detail\"\n        }\n    },\n    \"type\": \"object\",\n    \"title\": \"HTTPValidationError\"\n}\n</code></pre>"},{"location":"openapi/#post-apiv1apsannotatesemiring_name","title":"POST /api/v1/aps/annotate/{semiring_name}","text":"<p>Annotate Ap With Semiring</p> Description <p>Annotate the AP with the chosen semiring using dynamic database connection.</p> <p>Input parameters</p> Parameter In Type Default Nullable Description <code>semiring_name</code> path string No <p>Request body</p> application/json <p><pre><code>{\n    \"nodes\": [\n        {\n            \"id\": \"string\",\n            \"labels\": [\n                \"string\"\n            ],\n            \"properties\": null\n        }\n    ],\n    \"edges\": [\n        {\n            \"from\": \"string\",\n            \"labels\": [\n                \"string\"\n            ],\n            \"to\": \"string\",\n            \"properties\": null\n        }\n    ]\n}\n</code></pre> \u26a0\ufe0f This example has been generated automatically from the schema and it is not accurate. Refer to the schema for more information.</p> Schema of the request body <pre><code>{\n    \"properties\": {\n        \"nodes\": {\n            \"items\": {\n                \"$ref\": \"#/components/schemas/PgJsonNode\"\n            },\n            \"type\": \"array\",\n            \"title\": \"Nodes\"\n        },\n        \"edges\": {\n            \"items\": {\n                \"$ref\": \"#/components/schemas/PgJsonEdge\"\n            },\n            \"type\": \"array\",\n            \"title\": \"Edges\"\n        }\n    },\n    \"type\": \"object\",\n    \"required\": [\n        \"nodes\",\n        \"edges\"\n    ],\n    \"title\": \"PgJson\"\n}\n</code></pre> <p> Response 200 OK </p> application/json <p><pre><code>[\n    {\n        \"table_name\": \"string\",\n        \"semiring\": \"string\",\n        \"status\": \"success\",\n        \"message\": \"string\"\n    }\n]\n</code></pre> \u26a0\ufe0f This example has been generated automatically from the schema and it is not accurate. Refer to the schema for more information.</p> Schema of the response body <pre><code>{\n    \"type\": \"array\",\n    \"items\": {\n        \"$ref\": \"#/components/schemas/AnnotationResult\"\n    },\n    \"title\": \"Response Annotate Ap With Semiring Api V1 Aps Annotate  Semiring Name  Post\"\n}\n</code></pre> <p> Response 422 Unprocessable Content </p> application/json <p><pre><code>{\n    \"detail\": [\n        {\n            \"loc\": [\n                null\n            ],\n            \"msg\": \"string\",\n            \"type\": \"string\"\n        }\n    ]\n}\n</code></pre> \u26a0\ufe0f This example has been generated automatically from the schema and it is not accurate. Refer to the schema for more information.</p> Schema of the response body <pre><code>{\n    \"properties\": {\n        \"detail\": {\n            \"items\": {\n                \"$ref\": \"#/components/schemas/ValidationError\"\n            },\n            \"type\": \"array\",\n            \"title\": \"Detail\"\n        }\n    },\n    \"type\": \"object\",\n    \"title\": \"HTTPValidationError\"\n}\n</code></pre>"},{"location":"openapi/#post-apiv1apsexplain","title":"POST /api/v1/aps/explain","text":"<p>Explain Ap</p> Description <p>Explain the AP with all available semirings using dynamic database connection.</p> <p>Request body</p> application/json <p><pre><code>{\n    \"nodes\": [\n        {\n            \"id\": \"string\",\n            \"labels\": [\n                \"string\"\n            ],\n            \"properties\": null\n        }\n    ],\n    \"edges\": [\n        {\n            \"from\": \"string\",\n            \"labels\": [\n                \"string\"\n            ],\n            \"to\": \"string\",\n            \"properties\": null\n        }\n    ]\n}\n</code></pre> \u26a0\ufe0f This example has been generated automatically from the schema and it is not accurate. Refer to the schema for more information.</p> Schema of the request body <pre><code>{\n    \"properties\": {\n        \"nodes\": {\n            \"items\": {\n                \"$ref\": \"#/components/schemas/PgJsonNode\"\n            },\n            \"type\": \"array\",\n            \"title\": \"Nodes\"\n        },\n        \"edges\": {\n            \"items\": {\n                \"$ref\": \"#/components/schemas/PgJsonEdge\"\n            },\n            \"type\": \"array\",\n            \"title\": \"Edges\"\n        }\n    },\n    \"type\": \"object\",\n    \"required\": [\n        \"nodes\",\n        \"edges\"\n    ],\n    \"title\": \"PgJson\"\n}\n</code></pre> <p> Response 200 OK </p> application/json Schema of the response body <pre><code>\n</code></pre> <p> Response 422 Unprocessable Content </p> application/json <p><pre><code>{\n    \"detail\": [\n        {\n            \"loc\": [\n                null\n            ],\n            \"msg\": \"string\",\n            \"type\": \"string\"\n        }\n    ]\n}\n</code></pre> \u26a0\ufe0f This example has been generated automatically from the schema and it is not accurate. Refer to the schema for more information.</p> Schema of the response body <pre><code>{\n    \"properties\": {\n        \"detail\": {\n            \"items\": {\n                \"$ref\": \"#/components/schemas/ValidationError\"\n            },\n            \"type\": \"array\",\n            \"title\": \"Detail\"\n        }\n    },\n    \"type\": \"object\",\n    \"title\": \"HTTPValidationError\"\n}\n</code></pre>"},{"location":"openapi/#post-apiv1apsexplainsemiring_name","title":"POST /api/v1/aps/explain/{semiring_name}","text":"<p>Explain Ap With Semiring</p> Description <p>Explain the AP with only the chosen semiring using dynamic database connection.</p> <p>Input parameters</p> Parameter In Type Default Nullable Description <code>semiring_name</code> path string No <p>Request body</p> application/json <p><pre><code>{\n    \"nodes\": [\n        {\n            \"id\": \"string\",\n            \"labels\": [\n                \"string\"\n            ],\n            \"properties\": null\n        }\n    ],\n    \"edges\": [\n        {\n            \"from\": \"string\",\n            \"labels\": [\n                \"string\"\n            ],\n            \"to\": \"string\",\n            \"properties\": null\n        }\n    ]\n}\n</code></pre> \u26a0\ufe0f This example has been generated automatically from the schema and it is not accurate. Refer to the schema for more information.</p> Schema of the request body <pre><code>{\n    \"properties\": {\n        \"nodes\": {\n            \"items\": {\n                \"$ref\": \"#/components/schemas/PgJsonNode\"\n            },\n            \"type\": \"array\",\n            \"title\": \"Nodes\"\n        },\n        \"edges\": {\n            \"items\": {\n                \"$ref\": \"#/components/schemas/PgJsonEdge\"\n            },\n            \"type\": \"array\",\n            \"title\": \"Edges\"\n        }\n    },\n    \"type\": \"object\",\n    \"required\": [\n        \"nodes\",\n        \"edges\"\n    ],\n    \"title\": \"PgJson\"\n}\n</code></pre> <p> Response 200 OK </p> application/json Schema of the response body <pre><code>\n</code></pre> <p> Response 422 Unprocessable Content </p> application/json <p><pre><code>{\n    \"detail\": [\n        {\n            \"loc\": [\n                null\n            ],\n            \"msg\": \"string\",\n            \"type\": \"string\"\n        }\n    ]\n}\n</code></pre> \u26a0\ufe0f This example has been generated automatically from the schema and it is not accurate. Refer to the schema for more information.</p> Schema of the response body <pre><code>{\n    \"properties\": {\n        \"detail\": {\n            \"items\": {\n                \"$ref\": \"#/components/schemas/ValidationError\"\n            },\n            \"type\": \"array\",\n            \"title\": \"Detail\"\n        }\n    },\n    \"type\": \"object\",\n    \"title\": \"HTTPValidationError\"\n}\n</code></pre>"},{"location":"openapi/#get-apiv1health","title":"GET /api/v1/health","text":"<p>Health Check</p> <p> Response 200 OK </p> application/json Schema of the response body"},{"location":"openapi/#schemas","title":"Schemas","text":""},{"location":"openapi/#annotationresult","title":"AnnotationResult","text":"Name Type <code>message</code> string <code>semiring</code> string <code>status</code> string <code>table_name</code> string"},{"location":"openapi/#httpvalidationerror","title":"HTTPValidationError","text":"Name Type <code>detail</code> Array&lt;ValidationError&gt;"},{"location":"openapi/#pgjson","title":"PgJson","text":"Name Type <code>edges</code> Array&lt;PgJsonEdge&gt; <code>nodes</code> Array&lt;PgJsonNode&gt;"},{"location":"openapi/#pgjsonedge","title":"PgJsonEdge","text":"Name Type <code>from</code> string <code>labels</code> Array&lt;string&gt; <code>properties</code> <code>to</code> string"},{"location":"openapi/#pgjsonnode","title":"PgJsonNode","text":"Name Type <code>id</code> string <code>labels</code> Array&lt;string&gt; <code>properties</code>"},{"location":"openapi/#removalresult","title":"RemovalResult","text":"Name Type <code>message</code> string <code>semiring</code> string <code>status</code> string <code>table_name</code> string"},{"location":"openapi/#validationerror","title":"ValidationError","text":"Name Type <code>loc</code> Array&lt;&gt; <code>msg</code> string <code>type</code> string"},{"location":"troubleshooting/","title":"Troubleshooting","text":""},{"location":"troubleshooting/#common-errors","title":"Common Errors","text":""},{"location":"troubleshooting/#provsql-extension-not-found","title":"ProvSQL Extension Not Found","text":"<p>Error: <code>ProvSQL extension is not installed on the PostgreSQL server</code></p> <p>Cause: Database missing the ProvSQL extension</p> <p>Solution: <pre><code># Use the provided Docker image\ncd dependencies/postgres-provsql\ndocker build -t postgres-provsql .\ndocker run -d -p 5432:5432 postgres-provsql\n</code></pre></p> <p>Or install ProvSQL manually on your PostgreSQL instance.</p>"},{"location":"troubleshooting/#table-not-annotated","title":"Table Not Annotated","text":"<p>Error: <code>Table 'students' in schema 'public' is not annotated with semiring 'formula'</code></p> <p>Cause: Attempting to explain before annotating tables</p> <p>Solution: Annotate the table first: <pre><code>POST /api/v1/aps/annotate\n</code></pre></p>"},{"location":"troubleshooting/#table-or-schema-not-found","title":"Table or Schema Not Found","text":"<p>Error: <code>Table 'xyz' does not exist in schema 'public'</code></p> <p>Cause: Invalid table name or schema in AP</p> <p>Solution: Verify table exists: <pre><code>SELECT table_name FROM information_schema.tables \nWHERE table_schema = 'public';\n</code></pre></p>"},{"location":"troubleshooting/#semiring-operation-not-supported","title":"Semiring Operation Not Supported","text":"<p>Error: <code>Semiring 'why' does not support aggregate queries</code></p> <p>Cause: Using a semiring without aggregate function support on aggregation queries</p> <p>Solution: Use the <code>formula</code> semiring which supports aggregates, or rewrite query without aggregation.</p>"},{"location":"troubleshooting/#connection-issues","title":"Connection Issues","text":""},{"location":"troubleshooting/#cannot-connect-to-database","title":"Cannot Connect to Database","text":"<p>Check connection string format in AP: <pre><code>{\n  \"properties\": {\n    \"contentUrl\": \"postgresql://user:password@host:5432/dbname\"\n  }\n}\n</code></pre></p> <p>Verify: - Host and port are correct - Credentials are valid - Database exists on either the primary PostgreSQL or Timescale server - Network allows connection</p>"},{"location":"troubleshooting/#database-not-found","title":"Database Not Found","text":"<p>Error: <code>Database 'dbname' not found on either PostgreSQL or Timescale instances</code></p> <p>Cause: The database doesn't exist on either the primary PostgreSQL server or the Timescale fallback server</p> <p>Solution:  1. Verify the database name in the AP's <code>contentUrl</code> is correct 2. Check if the database exists on the primary PostgreSQL server:    <pre><code>psql -h $POSTGRES_HOST -p $POSTGRES_PORT -U $POSTGRES_USER -l\n</code></pre> 3. Check if the database exists on the Timescale server (if configured):    <pre><code>psql -h $POSTGRES_TIMESCALE_HOST -p $POSTGRES_TIMESCALE_PORT -U $POSTGRES_USER -l\n</code></pre> 4. Create the database if it doesn't exist:    <pre><code>CREATE DATABASE dbname;\n</code></pre></p>"},{"location":"troubleshooting/#missing-environment-variables","title":"Missing Environment Variables","text":"<p>Error: <code>Missing required environment variables: POSTGRES_USER, POSTGRES_PASSWORD, POSTGRES_HOST</code></p> <p>Cause: Required environment variables are not set</p> <p>Solution: Set the required environment variables: <pre><code>export POSTGRES_USER=your_user\nexport POSTGRES_PASSWORD=your_password\nexport POSTGRES_HOST=your_host\nexport POSTGRES_PORT=5432  # optional, defaults to 5432\n</code></pre></p> <p>Or create a <code>.env</code> file with these variables if the service loads them automatically.</p>"},{"location":"usage/","title":"Usage Guide","text":""},{"location":"usage/#basic-workflow","title":"Basic Workflow","text":""},{"location":"usage/#1-annotate-tables","title":"1. Annotate Tables","text":"<p>Before explaining queries, tables must be annotated (one-time per table):</p> <pre><code>curl -X POST http://localhost:5000/api/v1/aps/annotate \\\n  -H \"Content-Type: application/json\" \\\n  -d @fixtures/explain_sql_query.json\n</code></pre> <p>Response: <pre><code>[\n  {\n    \"table_name\": \"students\",\n    \"semiring\": \"formula\",\n    \"status\": \"success\",\n    \"message\": \"Table 'students' was successfully annotated with semiring 'formula'\"\n  }\n]\n</code></pre></p>"},{"location":"usage/#2-explain-queries","title":"2. Explain Queries","text":"<p>After annotation, get provenance explanations:</p> <pre><code>curl -X POST http://localhost:5000/api/v1/aps/explain \\\n  -H \"Content-Type: application/json\" \\\n  -d @fixtures/explain_sql_query.json\n</code></pre> <p>Important: The <code>/explain</code> endpoint automatically removes provenance annotations from tables after computing the provenance. This is a workaround to mitigate a known issue in ProvSQL (issue #67) where leaving provenance enabled can block certain database operations. </p> <p>Implications: - After calling <code>/explain</code>, tables will need to be re-annotated before you can explain queries again - This makes provenance computation more expensive, but it's necessary to prevent database blocking - If you need to explain multiple queries, consider doing so sequentially in a single session before the annotations are removed</p>"},{"location":"usage/#specific-semiring","title":"Specific Semiring","text":"<p>Use a specific semiring instead of all:</p> <pre><code># Annotate with formula semiring only\nPOST /api/v1/aps/annotate/formula\n\n# Explain with why semiring only\nPOST /api/v1/aps/explain/why\n</code></pre>"},{"location":"usage/#remove-annotations","title":"Remove Annotations","text":"<p>Clean up annotations when done:</p> <pre><code>curl -X DELETE http://localhost:5000/api/v1/aps/annotate \\\n  -H \"Content-Type: application/json\" \\\n  -d @fixtures/explain_sql_query.json\n</code></pre>"},{"location":"usage/#semiring-types","title":"Semiring Types","text":""},{"location":"usage/#formula-semiring","title":"Formula Semiring","text":"<p>Tracks complete data lineage as algebraic formulas: - Shows how results were computed - Operators: \u2295 (union), \u2297 (join), \u2296 (difference)</p>"},{"location":"usage/#why-semiring","title":"Why Semiring","text":"<p>Lists source tuples that contributed to results: - Shows which rows were used - Format: <code>table_name(row_id)</code></p>"}]}